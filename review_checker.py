import json
import os
import sys
import asyncio
from datetime import datetime

# Добавляем путь к папке llm для корректных импортов
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'llm'))

from llm.llm_router import llm_request  # type: ignore


async def check_review(review_text: str, gender: str = "", model: str = "grok-4-1-fast-reasoning") -> dict:
    """
    Асинхронно проверяет и корректирует отзыв через LLM модель.
    
    Args:
        review_text: Текст отзыва для проверки
        gender: Текущий пол (М/Ж/Н или пустая строка). По умолчанию пустая строка - модель определит сама
        model: Название модели из списка pricing (по умолчанию "grok-4-1-fast-reasoning")
        
    Returns:
        Словарь с полями:
        - content: Ответ от модели в формате JSON {"text": "...", "gender": "..."}
        - cost: Стоимость запроса в долларах
        
    Raises:
        Exception: Если модель не найдена в pricing или не поддерживается
    """
    # Получаем текущую дату
    current_date = datetime.now().strftime("%d.%m.%Y")
    
    # Формируем промпт с подстановкой параметров
    prompt = f"""
    Ты профессиональный редактор отзывов. Задача проверить отзыв согласно входным данным.
    ВХОДНЫЕ ДАННЫЕ:
    Текст отзыва: "{review_text}"
    Текущий пол: {gender}
    Текущая дата: {current_date}
    ЗАДАЧИ ПРОВЕРКИ:
    1. ОПРЕДЕЛЕНИЕ И КОРРЕКТИРОВКА ПОЛА
    Исправить пол и окончания, если:
    Текст написан преимущественно от женского лица + указан "М" (либо пол не указан) → изменить пол на "Ж" + скорректировать окончания (м→ж)
    Текст написан преимущественно от мужского лица + указан "Ж" (либо пол не указан) → изменить пол на "М" + скорректировать окончания (ж→м)
    В спорных случаях (признаков м/ж примерно поровну):
    Оставить текущий пол без изменений
    Скорректировать окончания под текущий пол
    Оставить как есть, если:
    Пол соответствует тексту
    Отзыв в нейтральном множественном числе ("обращались", "заказывали", "довольны") — это отзывы от компаний, пол "Н"
    2. КОРРЕКТИРОВКА ТЕКСТА
    Исправить грамматические ошибки (падежи, согласования, времена)
    3. ЛОГИЧЕСКИЕ НЕСООТВЕТСТВИЯ:
    Исправить логические несоответствия времени года/сезона/праздников относительно текущей даты (осень + 8 марта, лето + ёлки к НГ, зима + выпускной): заменить год/сезон/праздник на соответствующий текущей дате.
    При необходимости внеси корректировки, чтобы предложение было логичным и понятным для человека.
    
    Что НЕ ТРОГАТЬ:
    Опечатки и орфографические ошибки (сохранять как есть для естественности написания отзыва человеком)
    Стиль, тон и структуру отзыва
    
    ФОРМАТ ВЫДАЧИ:
    {{ "text": "исправленный текст отзыва (или оригинал, если не требовалось правок)", "gender": "М/Ж/Н" }}
    ВАЖНО: Верни ТОЛЬКО JSON словарь. Никаких дополнительных объяснений, пояснений, обоснований или комментариев.
    """
    
    # Определяем путь к файлу pricing относительно корня проекта
    current_dir = os.path.dirname(os.path.abspath(__file__))
    llm_dir = os.path.join(current_dir, "llm")
    pricing_path = os.path.join(llm_dir, "llm_pricing.json")
    
    # Загружаем список доступных моделей из pricing
    with open(pricing_path, "r", encoding="utf-8") as f:
        pricing = json.load(f)
    
    # Проверяем, что модель есть в pricing
    if model not in pricing:
        available_models = ", ".join(pricing.keys())
        raise Exception(
            f"Модель '{model}' не найдена в pricing.\n"
            f"Доступные модели: {available_models}"
        )
    
    # Формируем список сообщений в формате, который ожидает llm_router
    messages = [
        {"role": "user", "content": prompt}
    ]
    
    # Выполняем запрос через llm_router в отдельном потоке (асинхронно)
    # Это позволяет не блокировать event loop во время выполнения запроса
    result = await asyncio.to_thread(llm_request, model, messages)
    
    return result


if __name__ == "__main__":
    # Пример использования
    review_text = "В целом все неплохо. Цвиты у них харошие, есть много красивых готовых букетов. Но цены на некоторые необоснованно высокие. Круто если бы были скидки побольше на какие-то марта закупались например. Но качество действительно на уровне, так что я доволен."
    gender = ""
    model = "gpt-5.1"
    
    result = asyncio.run(check_review(review_text=review_text, gender=gender, model=model))
    
    print(result)

