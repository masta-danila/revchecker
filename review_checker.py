import json
import os
import sys
import asyncio
from datetime import datetime

# Добавляем путь к папке llm для корректных импортов
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'llm'))

from llm.llm_router import llm_request  # type: ignore


async def check_review(review_text: str, gender: str = "", model: str = "grok-4-1-fast-reasoning") -> dict:
    """
    Асинхронно проверяет и корректирует отзыв через LLM модель.
    
    Args:
        review_text: Текст отзыва для проверки
        gender: Текущий пол (М/Ж/Н или пустая строка). По умолчанию пустая строка - модель определит сама
        model: Название модели из списка pricing (по умолчанию "grok-4-1-fast-reasoning")
        
    Returns:
        Словарь с полями:
        - content: Ответ от модели в формате JSON {"text": "...", "gender": "..."}
        - cost: Стоимость запроса в долларах
        
    Raises:
        Exception: Если модель не найдена в pricing или не поддерживается
    """
    # Получаем текущую дату
    current_date = datetime.now().strftime("%d.%m.%Y")
    
    # Формируем промпт с подстановкой параметров
    prompt = f"""
    Ты профессиональный редактор отзывов. Задача проверить отзыв согласно входным данным и шагам.
    Исправляй текст последовательно согласно представленным шагам.
    ВХОДНЫЕ ДАННЫЕ:
    Текст отзыва: "{review_text}"
    Текущий пол: {gender}
    Текущая дата: {current_date}
    Шаг 1. ОПРЕДЕЛЕНИЕ И КОРРЕКТИРОВКА ПОЛА
    Исправить текущий пол и окончания в тексте отзыва, под наиболее логически верный вариант:
    Текст написан преимущественно от женского лица + указан "М" (либо пол не указан) → изменить пол на "Ж" + скорректировать окончания (м→ж)
    Текст написан преимущественно от мужского лица + указан "Ж" (либо пол не указан) → изменить пол на "М" + скорректировать окончания (ж→м)
    КОНТЕКСТНЫЕ ПОДСКАЗКИ для определения пола:
    - Цветы/букет ДАРЯТ автору → автор женского пола (Ж)
    - Цветы/букет дарит автор МУЖУ/ПАРНЮ/ОТЦУ → автор женского пола (Ж)
    - Цветы/букет дарит автор ЖЕНЕ/ДЕВУШКЕ/МАМЕ → автор мужского пола (М)
    - Машину дарят автору НА 8 МАРТА/ДЕНЬ РОЖДЕНИЯ (женский контекст) → автор женского пола (Ж)
    - Упоминание "муж подарил", "парень купил" → автор женского пола (Ж)
    - Упоминание "жена выбрала", "девушка попросила" → автор мужского пола (М)
    В спорных случаях (признаков м/ж примерно поровну):
    Оставить текущий пол без изменений
    Скорректировать окончания под текущий пол
    Оставить как есть, если:
    Пол соответствует тексту
    Отзыв в нейтральном множественном числе ("обращались", "заказывали", "довольны") — это отзывы от компаний, пол "Н"
    Шаг 2. КОРРЕКТИРОВКА ТЕКСТА
    СТРОГО ЗАПРЕЩЕНО ИСПРАВЛЯТЬ (сохраняй ТОЧНО как в оригинале):
    - Орфографические ошибки (опечатки в словах)
    - ПУНКТУАЦИЮ: запятые, точки, тире, двоеточия, восклицательные и вопросительные знаки - ВСЁ оставляй КАК ЕСТЬ
    - Переносы строк и пробелы
    - Буквы "е" вместо "ё" (это не ошибка)
    ЧТО МОЖНО ИСПРАВЛЯТЬ:
    - Грамматические ошибки (падежи, окончания, согласования)
    - Стилистические ошибки
    - Лексические ошибки (неправильное употребление слов)
    - Речевые ошибки
    - Фактические ошибки
    - Логические ошибки    
    Шаг 3. ЛОГИЧЕСКИЕ НЕСООТВЕТСТВИЯ:
    Исправить логические несоответствия времени года/сезона/праздников относительно текущей даты (осень + 8 марта, лето + ёлки к НГ, зима + выпускной): заменить год/сезон/праздник на соответствующий текущей дате.
    При необходимости внеси корректировки, чтобы предложение было логичным и понятным для человека.
    Шаг 4. ПОМЕТКА ОРФОГРАФИЧЕСКИХ ОШИБОК:
    ПОМЕТЬ:
    Слова, содержащие орфографические ошибки, помести в двойные квадратные скобки [[]].
    Пример: "вкусное [[малоко]]" (неправильная "а" вместо "о")
    НЕ ПОМЕЧАЙ:
    - слова в которых "е" вместо "ё" (это не ошибка)
    - сленговые общеупотребительные слова, типа "замутить", "ништяк", "аудюшка", "бэха" и т.п. (это не ошибки)
    
    ФОРМАТ ВЫДАЧИ:
    {{ "text": "исправленный текст отзыва (или оригинал, если не требовалось правок)", "gender": "М/Ж/Н" }}
    ВАЖНО: Верни ТОЛЬКО JSON словарь. Никаких дополнительных объяснений, пояснений, обоснований или комментариев.
    """
    
    # Определяем путь к файлу pricing относительно корня проекта
    current_dir = os.path.dirname(os.path.abspath(__file__))
    llm_dir = os.path.join(current_dir, "llm")
    pricing_path = os.path.join(llm_dir, "llm_pricing.json")
    
    # Загружаем список доступных моделей из pricing
    with open(pricing_path, "r", encoding="utf-8") as f:
        pricing = json.load(f)
    
    # Проверяем, что модель есть в pricing
    if model not in pricing:
        available_models = ", ".join(pricing.keys())
        raise Exception(
            f"Модель '{model}' не найдена в pricing.\n"
            f"Доступные модели: {available_models}"
        )
    
    # Формируем список сообщений в формате, который ожидает llm_router
    messages = [
        {"role": "user", "content": prompt}
    ]
    
    # Выполняем запрос через llm_router в отдельном потоке (асинхронно)
    # Это позволяет не блокировать event loop во время выполнения запроса
    result = await asyncio.to_thread(llm_request, model, messages)
    
    return result


if __name__ == "__main__":
    # Пример использования
    review_text = "Флорист просто чудо, собрала невероятный букет из роз и гербер, все в моих любимых оттенках. Привезли без опозданий (заказ онлайн оформляла), упаковка стильная, не мятая. Жена в восторге была, спасибо вам от души."
    gender = "Ж"
    model = "gpt-4o"
    
    result = asyncio.run(check_review(review_text=review_text, gender=gender, model=model))
    
    print(result)

